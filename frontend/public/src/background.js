var S={};const f=S.REACT_APP_API_URL||"http://127.0.0.1:8000",E=3e4,b=5e3;async function C(e,t){const r=new AbortController;let o=null;try{if(console.debug("[API] Starting analysis request",{url:e.url,contentLength:e.content.length,imageCount:e.images?.length??0}),!e.content||e.content.trim().length===0)throw new g("Content cannot be empty");if(e.content.length<50)throw new g("Content too short (minimum 50 characters required)");e.content.length>5e4&&(console.warn("[API] Content exceeds 50KB, truncating"),e.content=e.content.substring(0,5e4)),o=setTimeout(()=>{r.abort()},E);const n=_(t,r.signal),a=await fetch(`${f}/api/analyze`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Pragma:"no-cache","Cache-Control":"no-cache"},body:JSON.stringify(e),signal:n});if(!a.ok){const l=await a.json().catch(()=>({}));throw a.status===400?new g(l.detail||"Invalid content submission"):a.status===500?new A(l.detail||"Backend processing failed","Try again in a moment or contact support if problem persists"):new h(`HTTP ${a.status}: ${a.statusText}`,l.detail||"Check backend logs for details")}const u=await a.json();return console.debug("[API] Analysis complete",{credibilityScore:u.credibilityScore,findings:u.findings.length}),u}catch(n){if(n instanceof g||n instanceof A)throw n;if(n.name==="AbortError"){const a=r.signal.aborted&&o;throw new I(a?"Analysis timeout (30 seconds). Backend might be processing slowly or unresponsive.":"Analysis cancelled by user")}throw n instanceof TypeError&&n.message.includes("Failed to fetch")?new v(`Cannot reach backend at ${f}`,"Ensure FastAPI server is running: python -m uvicorn app.main:app --reload"):new h(n.message||"Unknown error during analysis","Check browser console for stack trace")}finally{o&&clearTimeout(o)}}async function w(){try{console.debug("[API] Checking backend health...");const e=new AbortController,t=setTimeout(()=>e.abort(),b);try{const r=await fetch(`${f}/health`,{method:"GET",signal:e.signal});clearTimeout(t);const o=r.ok;return o?console.debug("[API] Backend is healthy"):console.warn("[API] Backend returned non-OK status:",r.status),o}catch(r){return clearTimeout(t),r.name==="AbortError"?console.warn("[API] Health check timed out"):console.warn("[API] Health check failed:",r.message),!1}}catch(e){return console.error("[API] Unexpected error in health check:",e),!1}}class h extends Error{constructor(t,r=t,o){super(t),this.userMessage=r,this.details=o,this.name="APIError"}}class g extends h{constructor(t){super(t,`Invalid content: ${t}`),this.name="ValidationError"}}class v extends h{constructor(t,r){super(t,r||t),this.name="NetworkError"}}class I extends h{constructor(t){super(t,t),this.name="TimeoutError"}}class A extends h{constructor(t,r){super(t,r||t),this.name="ServerError"}}function _(...e){if(e.length===0)return new AbortController().signal;const t=e.filter(o=>!!o);if(t.length===0)return new AbortController().signal;if(t.length===1)return t[0];const r=new AbortController;return t.forEach(o=>{o.addEventListener("abort",()=>r.abort())}),r.signal}const d=new Map;let y=!1,p=0;const T=6e4;chrome.runtime.onMessage.addListener((e,t,r)=>{if(console.debug("[Service Worker] Received message:",e.type),e.type==="ANALYZE_PAGE")return P(e,t,r),!0;if(e.type==="GET_CACHED_ANALYSIS")return L(e,r),!0;if(e.type==="CANCEL_ANALYSIS")return W(e,r),!0;if(e.type==="CHECK_BACKEND_HEALTH")return H(r),!0;if(e.type==="CLEAR_CACHE")return $(r),!0});async function P(e,t,r){const{url:o,content:n,title:a,images:u}=e.payload,l=t.tab?.id;if(!n||n.trim().length<50){const s="Content too short. Please select at least 50 characters.";console.warn("[Service Worker] Validation error:",s),r({status:"error",error:s});return}if(!l){console.warn("[Service Worker] No tab ID found"),r({status:"error",error:"Could not identify active tab"});return}const m=new AbortController;d.set(l,m);try{console.log(`[Service Worker] Starting analysis for ${o}`),console.debug(`[Service Worker] Content length: ${n.length} chars`),await B(),i({type:"ANALYSIS_PROGRESS",payload:{status:"Checking cache...",progress:10}});const s=await chrome.storage.local.get(`analysis_${o}`);if(s[`analysis_${o}`]&&Date.now()-s[`analysis_${o}`].timestamp<36e5){console.log("[Service Worker] Using cached result"),i({type:"ANALYSIS_COMPLETE",payload:{result:s[`analysis_${o}`].result,cached:!0}}),d.delete(l),r({status:"complete",cached:!0});return}i({type:"ANALYSIS_PROGRESS",payload:{status:"Analyzing content...",progress:20}});const c=await C({url:o,content:n,title:a,images:u},m.signal);i({type:"ANALYSIS_PROGRESS",payload:{status:"Processing results...",progress:90}}),await chrome.storage.local.set({[`analysis_${o}`]:{result:c,timestamp:Date.now()}}),console.log("[Service Worker] Analysis complete"),i({type:"ANALYSIS_COMPLETE",payload:{result:c,cached:!1}}),r({status:"complete"})}catch(s){console.error("[Service Worker] Analysis error:",s);let c=s.message||"Analysis failed. Please try again.";s.name==="AbortError"?c="Analysis cancelled":s.message.includes("Failed to fetch")?c="Backend unreachable. Ensure FastAPI server is running at http://localhost:8000":s.message.includes("timeout")?c="Analysis timeout. The content might be too complex or the backend is slow.":s.message.includes("400")?c="Invalid content. The backend could not parse the submission.":s.message.includes("500")&&(c="Backend error. The analysis pipeline encountered an issue."),console.error("[Service Worker] Error message for user:",c),i({type:"ANALYSIS_ERROR",payload:{error:c,url:o}}),r({status:"error",error:c})}finally{d.delete(l)}}async function L(e,t){const{url:r}=e.payload,o=await chrome.storage.local.get(`analysis_${r}`);o[`analysis_${r}`]?t({found:!0,data:o[`analysis_${r}`].result}):t({found:!1})}function W(e,t){const{tabId:r}=e.payload,o=d.get(r);o?(o.abort(),d.delete(r),console.log("[Service Worker] Analysis cancelled"),t({status:"cancelled"})):t({status:"no_active_request"})}async function H(e){try{const t=await w();console.log("[Service Worker] Backend health:",t?"OK":"FAILED"),e({healthy:t})}catch(t){console.error("[Service Worker] Health check error:",t),e({healthy:!1})}}async function $(e){const t=await chrome.storage.local.get(),r=Object.keys(t).filter(o=>o.startsWith("analysis_"));await chrome.storage.local.remove(r),console.log(`[Service Worker] Cleared ${r.length} cache entries`),e({cleared:r.length})}async function B(){const e=Date.now();if(e-p<T){if(!y)throw new Error("Backend is unreachable");return}p=e;try{if(y=await w(),!y)throw new Error("Backend health check failed");console.log("[Service Worker] Backend is healthy")}catch(t){throw console.error("[Service Worker] Backend health check failed:",t),new Error("Backend unreachable at http://127.0.0.1:8000. Is FastAPI running?")}}function i(e){chrome.runtime.sendMessage(e).catch(()=>{console.debug("[Service Worker] Popup not open, message not delivered")})}chrome.runtime.onInstalled.addListener(async()=>{console.log("[Service Worker] Extension installed"),await k()});chrome.alarms.create("cleanupCache",{periodInMinutes:24*60});chrome.alarms.onAlarm.addListener(e=>{e.name==="cleanupCache"&&(console.log("[Service Worker] Running scheduled cache cleanup"),k())});async function k(){const e=await chrome.storage.local.get(),t=Date.now()-7*24*60*60*1e3;let r=0;for(const[o,n]of Object.entries(e))if(o.startsWith("analysis_")){const a=n;a.timestamp&&a.timestamp<t&&(await chrome.storage.local.remove(o),r++)}r>0&&console.log(`[Service Worker] Cache cleanup: removed ${r} old entries`)}console.log("[Service Worker] Trust Issues service worker loaded");
