var C={};const f=C.REACT_APP_API_URL||"http://127.0.0.1:8000",v=12e4,I=5e3;async function _(e,t){const r=new AbortController;let o=null;try{if(console.debug("[API] Starting analysis request",{url:e.url,contentLength:e.content.length,imageCount:e.images?.length??0}),!e.content||e.content.trim().length===0)throw new d("Content cannot be empty");if(e.content.length<50)throw new d("Content too short (minimum 50 characters required)");e.content.length>5e4&&(console.warn("[API] Content exceeds 50KB, truncating"),e.content=e.content.substring(0,5e4)),o=setTimeout(()=>{r.abort()},v);const n=L(t,r.signal),a=await fetch(`${f}/api/analyze`,{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Pragma:"no-cache","Cache-Control":"no-cache"},body:JSON.stringify(e),signal:n});if(!a.ok){const l=await a.json().catch(()=>({}));throw a.status===400?new d(l.detail||"Invalid content submission"):a.status===500?new S(l.detail||"Backend processing failed","Try again in a moment or contact support if problem persists"):new i(`HTTP ${a.status}: ${a.statusText}`,l.detail||"Check backend logs for details")}const h=await a.json();return console.debug("[API] Analysis complete",{credibilityScore:h.credibilityScore,findings:h.findings.length}),h}catch(n){if(n instanceof d||n instanceof S)throw n;if(n.name==="AbortError"){const a=r.signal.aborted&&o;throw new P(a?"Analysis timeout (30 seconds). Backend might be processing slowly or unresponsive.":"Analysis cancelled by user")}throw n instanceof TypeError&&n.message.includes("Failed to fetch")?new T(`Cannot reach backend at ${f}`,"Ensure FastAPI server is running: python -m uvicorn app.main:app --reload"):new i(n.message||"Unknown error during analysis","Check browser console for stack trace")}finally{o&&clearTimeout(o)}}async function E(){try{console.debug("[API] Checking backend health...");const e=new AbortController,t=setTimeout(()=>e.abort(),I);try{const r=await fetch(`${f}/health`,{method:"GET",signal:e.signal});clearTimeout(t);const o=r.ok;return o?console.debug("[API] Backend is healthy"):console.warn("[API] Backend returned non-OK status:",r.status),o}catch(r){return clearTimeout(t),r.name==="AbortError"?console.warn("[API] Health check timed out"):console.warn("[API] Health check failed:",r.message),!1}}catch(e){return console.error("[API] Unexpected error in health check:",e),!1}}class i extends Error{constructor(t,r=t,o){super(t),this.userMessage=r,this.details=o,this.name="APIError"}}class d extends i{constructor(t){super(t,`Invalid content: ${t}`),this.name="ValidationError"}}class T extends i{constructor(t,r){super(t,r||t),this.name="NetworkError"}}class P extends i{constructor(t){super(t,t),this.name="TimeoutError"}}class S extends i{constructor(t,r){super(t,r||t),this.name="ServerError"}}function L(...e){if(e.length===0)return new AbortController().signal;const t=e.filter(o=>!!o);if(t.length===0)return new AbortController().signal;if(t.length===1)return t[0];const r=new AbortController;return t.forEach(o=>{o.addEventListener("abort",()=>r.abort())}),r.signal}const u=new Map,k=new Map;let y=!1,w=0;const W=6e4;chrome.runtime.onMessage.addListener((e,t,r)=>{if(console.debug("[Service Worker] Received message:",e.type),console.debug("[Service Worker] Message from:",t.tab?.url||t.url||"unknown"),e.type==="ANALYZE_PAGE")return H(e,t,r),!0;if(e.type==="GET_CACHED_ANALYSIS")return N(e,r),!0;if(e.type==="CANCEL_ANALYSIS")return R(e,r),!0;if(e.type==="CHECK_BACKEND_HEALTH")return O(r),!0;if(e.type==="CLEAR_CACHE")return $(r),!0});async function H(e,t,r){const{url:o,content:n,title:a,images:h}=e.payload,l=t.tab?.id??e.payload?.tabId;if(!n||n.trim().length<50){const c="Content too short. Please select at least 50 characters.";console.warn("[Service Worker] Validation error:",c),r({type:"ANALYSIS_ERROR",payload:{error:c,url:o}});return}if(!l){console.warn("[Service Worker] No tab ID found"),r({type:"ANALYSIS_ERROR",payload:{error:"Could not identify active tab",url:o}});return}const A=new AbortController;u.set(l,A);const m=t.tab?.id??-1;k.set(m,t);try{console.log(`[Service Worker] Starting analysis for ${o}`),console.debug(`[Service Worker] Content length: ${n.length} chars`),await B(),g({type:"ANALYSIS_PROGRESS",payload:{status:"Checking cache...",progress:10}});const c=`analysis_${o}`,s=await chrome.storage.local.get(c);if(s[`analysis_${o}`]&&Date.now()-s[`analysis_${o}`].timestamp<36e5){console.log("[Service Worker] Using cached result"),g({type:"ANALYSIS_COMPLETE",payload:{result:s[`analysis_${o}`].result,cached:!0}}),u.delete(l),r({type:"ANALYSIS_COMPLETE",payload:{result:s[`analysis_${o}`].result,cached:!0}});return}g({type:"ANALYSIS_PROGRESS",payload:{status:"Analyzing content...",progress:20}});const p=await _({url:o,content:n,title:a,images:h},A.signal);g({type:"ANALYSIS_PROGRESS",payload:{status:"Processing results...",progress:90}}),await chrome.storage.local.set({[`analysis_${o}`]:{result:p,timestamp:Date.now()}}),console.log("[Service Worker] Analysis complete"),console.log("[Service Worker] Sending ANALYSIS_COMPLETE via sendResponse"),r({type:"ANALYSIS_COMPLETE",payload:{result:p,cached:!1}})}catch(c){console.error("[Service Worker] Analysis error:",c);let s=c.message||"Analysis failed. Please try again.";c.name==="AbortError"?s="Analysis cancelled":c.message.includes("Failed to fetch")?s="Backend unreachable. Ensure FastAPI server is running at http://localhost:8000":c.message.includes("timeout")?s="Analysis timeout. The content might be too complex or the backend is slow.":c.message.includes("400")?s="Invalid content. The backend could not parse the submission.":c.message.includes("500")&&(s="Backend error. The analysis pipeline encountered an issue."),console.error("[Service Worker] Error message for user:",s),console.log("[Service Worker] Sending ANALYSIS_ERROR via sendResponse"),r({type:"ANALYSIS_ERROR",payload:{error:s,url:o}})}finally{u.delete(l),k.delete(m)}}async function N(e,t){const{url:r}=e.payload,o=`analysis_${r}`,n=await chrome.storage.local.get(o);n[`analysis_${r}`]?t({found:!0,data:n[`analysis_${r}`].result}):t({found:!1})}function R(e,t){const{tabId:r}=e.payload,o=u.get(r);o?(o.abort(),u.delete(r),console.log("[Service Worker] Analysis cancelled"),t({status:"cancelled"})):t({status:"no_active_request"})}async function O(e){try{const t=await E();console.log("[Service Worker] Backend health:",t?"OK":"FAILED"),e({healthy:t})}catch(t){console.error("[Service Worker] Health check error:",t),e({healthy:!1})}}async function $(e){const t=await chrome.storage.local.get(),r=Object.keys(t).filter(o=>o.startsWith("analysis_"));await chrome.storage.local.remove(r),console.log(`[Service Worker] Cleared ${r.length} cache entries`),e({cleared:r.length})}async function B(){const e=Date.now();if(e-w<W){if(!y)throw new Error("Backend is unreachable");return}w=e;try{if(y=await E(),!y)throw new Error("Backend health check failed");console.log("[Service Worker] Backend is healthy")}catch(t){throw console.error("[Service Worker] Backend health check failed:",t),new Error("Backend unreachable at http://127.0.0.1:8000. Is FastAPI running?")}}function g(e){chrome.runtime.sendMessage(e).catch(()=>{console.debug("[Service Worker] Popup not open, message not delivered")})}chrome.runtime.onInstalled.addListener(async()=>{console.log("[Service Worker] Extension installed"),await b()});chrome.alarms.create("cleanupCache",{periodInMinutes:24*60});chrome.alarms.onAlarm.addListener(e=>{e.name==="cleanupCache"&&(console.log("[Service Worker] Running scheduled cache cleanup"),b())});async function b(){const e=await chrome.storage.local.get(),t=Date.now()-7*24*60*60*1e3;let r=0;for(const[o,n]of Object.entries(e))if(o.startsWith("analysis_")){const a=n;a.timestamp&&a.timestamp<t&&(await chrome.storage.local.remove(o),r++)}r>0&&console.log(`[Service Worker] Cache cleanup: removed ${r} old entries`)}console.log("[Service Worker] Trust Issues service worker loaded");
